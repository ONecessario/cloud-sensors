<html>
	<head>
		<meta charset="utf-8">
		<script src="./mqttws31.min.js" type="text/javascript"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

	</head>
	<body>
		<div>
			<input type="text" id="val" placeholder="FrequÃªncia em segundos"> <button type="button" id="freq">Atualizar</button>
		</div>
		<canvas id="myChart"></canvas>

		<script>
			const el = document.getElementById("freq");
			el.addEventListener('click', function(evt) {
				const field = document.getElementById("val");
				const value = field.value;
				mqtt.publish('sensor/set_frequency', value);
			});
			const onConnect = () => {
				console.log("Connected");
				mqtt.subscribe('sensors/update', { onSuccess: () => console.log("Subscribe to sensors/update")});
			}
			const onMessageArrived = function(data) {
				const topic = data.destinationName;
				const info = data._getPayloadString();
				console.log(topic,info);
				if(topic != 'sensors/update') return ;
				const json = JSON.parse(info);
				let labels = json.labels;
				const dataset = json.dataset.map( (set) => {
					return {
						label: set.name,
						data: set.values
					}
				});
				removeData(chart);
				addData(chart, labels, dataset);
			}
			//const host = '10.0.0.101';
			const host = '127.0.0.1';
			const mqtt = new Paho.MQTT.Client(host, 9001, "clientjs");
			mqtt.onMessageArrived = onMessageArrived;
			mqtt.connect({
				//userName: 'aluno',
				//password:"@luno*123", 
				timeout: 3, 
				onSuccess: onConnect
			});
			//mtt.connect({timeout: 3, onSuccess: onConnect});
			const ctx = document.getElementById('myChart');
			const generateLabels = () => [...'abced'];
			const generateData = () => Array(5).fill(' ').map( e => Math.floor(Math.random()*100));
			const data = {
  			  labels: generateLabels(),
  			  datasets: [
    			{
      			  label: 'D0',
      			  data: generateData(),
      			  hidden: true
    			},
    			{
      			  label: 'D1',
      			  data: generateData(),
    			},
    			{
      			  label: 'D2',
      			  data: generateData(),
      			  hidden: true,
    			},
    			{
      			  label: 'D3',
      			  data: generateData(),
    			},
    			{
      			  label: 'D4',
      			  data: generateData(),
    			},
    			{
      			  label: 'D5',
      			  data: generateData(),
    			},
    			{
      			  label: 'D6',
      			  data: generateData(),
    			},
    			{
      			  label: 'D7',
      			  data: generateData(),
    			},
    			{
      			  label: 'D8',
      			  data: generateData(),
      			  hidden: true
    			},
    			{
      			  label: 'D9',
      			  data: generateData(),
    			}
  			  ]
			};
			const chart = new Chart(ctx, {
				type: 'line',
				data,
				options: {
  			  	  scales: {
    				y: {
      			  	  beginAtZero: true
    				}
  			  	  }
				}
			});
			function addData(chart, label, data) {
    			chart.data.labels = label;
    			chart.data.datasets = data
    			chart.update();
			}

			function removeData(chart) {
    			chart.data.labels = [];
    			chart.data.datasets = [];
    			chart.update();
			}
		</script>
	</body>
</html>
